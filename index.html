<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
<title>Roadbook Logger Pro</title>

<meta name="theme-color" content="#0b0f14">
<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{
  --bg:#0b0f14;
  --card:#121826;
  --muted:#9fb0c3;
  --btn:#1b2536;
  --line:#223;
  --ok:#4dd4ac;
  --warn:#ffcc66;
}

body{margin:0;background:var(--bg);color:#e8eef6;font-family:system-ui; overflow-x:hidden;}
.card{background:var(--card);border-radius:14px;padding:10px;margin:8px}

.top-row{display:flex;gap:8px;align-items:stretch}
.trip-card{flex:1; cursor:pointer;}
.photo-btn{
  width:56px;
  background:var(--btn);
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  cursor:pointer;
}

.big{
  font-size:52px;
  font-family:monospace;
  line-height:1;
  text-align:right;
  padding-right:1ch;
  color: #fff;
}
.label{font-size:11px;color:var(--muted); text-transform:uppercase; letter-spacing:1px;}

button{
  background:var(--btn);
  color:#fff;
  border:none;
  border-radius:8px;
  padding:8px 12px;
  font-size:12px;
}

.gps-bar{display:flex;align-items:center;gap:8px}
.gps-info{flex:1;display:flex;gap:10px;justify-content:center;font-size:11px;}
#recBtn.rec{color:var(--ok); font-weight:bold;}
#recBtn.pause{color:var(--warn)}

#map{height:250px;border-radius:14px;position:relative}
#recenter{
  position:absolute; bottom:12px; right:12px; z-index:2000;
  background:var(--btn); border-radius:50%; width:40px; height:40px;
  display:flex; align-items:center; justify-content:center; font-size:20px;
}

table{width:100%;border-collapse:collapse;font-size:12px}
td,th{border-bottom:1px solid var(--line);padding:8px;text-align:center;}
thead th{color:var(--muted);}

input{
  background:var(--btn); color:#fff; border:1px solid #333;
  border-radius:6px; padding:4px; font-size:12px;
}
.session-input { width: 100%; margin-bottom: 5px; box-sizing: border-box; padding: 10px; font-weight: bold; color: var(--ok); }

.toast{
  position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
  background:#0e1522; border:1px solid var(--line); color:#fff;
  padding:10px 20px; border-radius:12px; z-index:9999; opacity:0; transition:opacity .2s;
}
.toast.show{opacity:1}
</style>
</head>

<body onload="startGPS()">

<div class="card">
  <div class="label">Nome Sessione / File Export</div>
  <input type="text" id="sessionName" class="session-input" placeholder="Es: Gara_Domenica_01">
</div>

<div class="top-row">
  <div class="card trip-card" id="tripTotCard" onclick="manualAdjustTot()">
    <div class="label">TRIP TOTALE (click per modifica)</div>
    <div class="big" id="odoTot">0.000</div>
    <div class="label" style="font-size:9px; margin-top:5px;">Ghost Trip (Sempre attivo): <span id="odoGhost">0.000</span></div>
  </div>
  <div class="photo-btn" onclick="takePhoto()">ðŸ“·</div>
</div>

<div class="card gps-bar">
  <div class="gps-info">
    <span id="fix">ATTESA GPS...</span>
    <span id="acc">Â±â€” m</span>
    <span id="hz">â€” Hz</span>
  </div>
  <button id="recBtn" class="pause" onclick="toggleRec()">PAUSA</button>
</div>

<div class="card"><div id="map"><div id="recenter" onclick="recenter()">ðŸŽ¯</div></div></div>

<div class="card" onclick="addPoint()">
  <div class="label">TRIP PARZIALE (tap = punto + reset)</div>
  <div class="big" id="odoParz">0.000</div>
</div>

<div class="card" style="overflow-x:auto">
<table>
<thead>
<tr>
  <th>#</th>
  <th>KM Tot</th>
  <th>KM Parz</th>
  <th>Media</th>
  <th>Ora</th>
  <th>Att</th>
  <th></th>
</tr>
</thead>
<tbody id="points"></tbody>
</table>
</div>

<div class="card">
  <button onclick="exportCSV()">Excel</button>
  <button onclick="exportGPX()">GPX</button>
  <button onclick="exportKMZ()">KMZ</button>
</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
<div id="toast" class="toast"></div>

<script>
let state = {
  watchId: null, recording: false,
  lastFix: null, lastFixTimeMs: null,
  odoTotKm: 0, odoParzKm: 0, odoGhostKm: 0, // Ghost calcola sempre
  lastPointTime: null, lastPointGhostDist: 0,
  trackSegments: [], currentSegment: null, trackLines: [],
  points: [], photos: [],
  nextPointId: 1, activePointId: null
};

const map = L.map("map").setView([45, 9], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

function startGPS() {
    if (!navigator.geolocation) return toast("GPS non supportato");
    const opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 };
    state.watchId = navigator.geolocation.watchPosition(onFix, (e) => toast("Errore GPS"), opts);
    if ('wakeLock' in navigator) navigator.wakeLock.request('screen');
}

function onFix(pos) {
    const crd = pos.coords;
    const now = Date.now();
    
    // Logica Hz
    if (state.lastFixTimeMs) {
        let hz = (1000 / (now - state.lastFixTimeMs)).toFixed(1);
        document.getElementById("hz").textContent = hz + " Hz";
    }
    state.lastFixTimeMs = now;
    document.getElementById("acc").textContent = "Â±" + Math.round(crd.accuracy) + "m";
    document.getElementById("fix").textContent = "FIX OK";

    if (state.lastFix) {
        let dist = calculateDistance(state.lastFix.lat, state.lastFix.lon, crd.latitude, crd.longitude);
        
        // FILTRO LOGICA v7
        if (crd.speed > 0.22 || (crd.accuracy < 10 && dist > 0.05)) {
            // Ghost trip calcola SEMPRE
            state.odoGhostKm += (dist / 1000);
            
            // Trip Tot e Parz calcolano solo in REC
            if (state.recording) {
                state.odoTotKm += (dist / 1000);
                state.odoParzKm += (dist / 1000);
                if (state.currentSegment) {
                    state.currentSegment.push({lat: crd.latitude, lon: crd.longitude, timeMs: now});
                    state.trackLines[state.trackLines.length-1].addLatLng([crd.latitude, crd.longitude]);
                }
            }
            updateUI();
        }
    }
    state.lastFix = { lat: crd.latitude, lon: crd.longitude, timeMs: now };
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function updateUI() {
    document.getElementById("odoTot").textContent = state.odoTotKm.toFixed(3);
    document.getElementById("odoParz").textContent = state.odoParzKm.toFixed(3);
    document.getElementById("odoGhost").textContent = state.odoGhostKm.toFixed(3);
}

function toggleRec() {
    state.recording = !state.recording;
    const btn = document.getElementById("recBtn");
    btn.textContent = state.recording ? "REC" : "PAUSA";
    btn.className = state.recording ? "rec" : "pause";
    if (state.recording) {
        state.currentSegment = [];
        state.trackSegments.push(state.currentSegment);
        state.trackLines.push(L.polyline([], {color: "#4dd4ac"}).addTo(map));
    }
}

function manualAdjustTot() {
    let newVal = prompt("Inserisci nuovo valore KM Totale:", state.odoTotKm.toFixed(3));
    if (newVal !== null) {
        state.odoTotKm = parseFloat(newVal) || 0;
        updateUI();
    }
}

function addPoint() {
    if (!state.lastFix) return toast("No GPS Fix");
    
    let now = Date.now();
    let distFromLast = state.odoGhostKm - state.lastPointGhostDist;
    let timeFromLast = state.lastPointTime ? (now - state.lastPointTime) / 3600000 : 0;
    let avgSpeed = (timeFromLast > 0) ? (distFromLast / timeFromLast).toFixed(1) : "0";

    const p = {
        id: state.nextPointId++,
        kmTot: state.odoTotKm.toFixed(3),
        kmParz: state.odoParzKm.toFixed(3),
        avg: avgSpeed,
        time: new Date().toLocaleTimeString(),
        lat: state.lastFix.lat, lon: state.lastFix.lon,
        att: ""
    };

    state.points.unshift(p);
    state.lastPointGhostDist = state.odoGhostKm;
    state.lastPointTime = now;
    state.odoParzKm = 0;
    updateUI();
    renderTable();
}

function renderTable() {
    const tb = document.getElementById("points");
    tb.innerHTML = state.points.map(p => `
        <tr>
            <td>${p.id}</td>
            <td>${p.kmTot}</td>
            <td>${p.kmParz}</td>
            <td style="color:var(--warn)">${p.avg}</td>
            <td>${p.time}</td>
            <td><input oninput="updateAtt(${p.id}, this.value)" value="${p.att}" style="width:50px"></td>
            <td onclick="deletePoint(${p.id})">ðŸ—‘</td>
        </tr>
    `).join('');
}

function updateAtt(id, val) { 
    let p = state.points.find(x => x.id === id);
    if(p) p.att = val;
}

function deletePoint(id) {
    state.points = state.points.filter(p => p.id !== id);
    renderTable();
}

function getFileName(ext) {
    let name = document.getElementById("sessionName").value.trim().replace(/\s+/g, '_');
    return (name || "export") + "_" + new Date().getTime() + "." + ext;
}

function exportCSV() {
    let csv = "ID;KM_TOT;KM_PARZ;MEDIA;ORA;LAT;LON;NOTE\n";
    state.points.slice().reverse().forEach(p => {
        csv += `${p.id};${p.kmTot};${p.kmParz};${p.avg};${p.time};${p.lat};${p.lon};${p.att}\n`;
    });
    downloadFile(getFileName("csv"), csv, "text/csv");
}

function downloadFile(name, content, type) {
    const blob = new Blob([content], {type});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
}

function toast(m) {
    let t = document.getElementById("toast");
    t.textContent = m; t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
}

function recenter() { if(state.lastFix) map.setView([state.lastFix.lat, state.lastFix.lon], 16); }
</script>
</body>
</html>
