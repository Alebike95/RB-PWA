<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=yes">
<title>Roadbook Logger Pro v12.3.0-unified</title>

<meta name="theme-color" content="#0b0f14">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{
  --bg:#0b0f14; --card:#121826; --muted:#9fb0c3; --btn:#1b2536;
  --line:#223; --ok:#4dd4ac; --warn:#ffcc66; --danger:#ff6b6b;
}
html, body { 
    height: 100%; overflow-y: auto !important; 
    overscroll-behavior-y: contain !important;
    touch-action: pan-y !important; 
    margin:0; background:var(--bg); color:#e8eef6; font-family:system-ui; user-select:none;
}
.card{background:var(--card);border-radius:10px;padding:8px;margin:6px; touch-action: auto;}
.top-row{display:flex;gap:8px;align-items:stretch; position:relative;}

.ver-badge {
    position: absolute; top: -5px; right: 5px;
    font-size: 9px; font-family: monospace;
    background: var(--btn); color: var(--muted);
    padding: 2px 6px; border-radius: 10px; border: 1px solid var(--line);
}

.trip-card{flex:1; cursor:pointer;}
.photo-btn{ width:56px; background:var(--btn); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:26px; }
.big{ font-size:52px; font-family:monospace; line-height:1; text-align:right; padding-right:1ch; color:#fff; }
.label{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;}
.gps-bar{display:flex; align-items:center; gap:8px}
.gps-info{flex:1; display:flex; gap:10px; justify-content:center; font-size:11px;}
#recBtn.rec{color:var(--ok); font-weight:bold;}
#recBtn.pause{color:var(--warn)}
#map{height:250px; border-radius:14px; position:relative; touch-action: none;}
#recenter{ position:absolute; bottom:12px; right:12px; z-index:2000; background:var(--btn); border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-size:20px; }

#recIndicator {
    position: absolute; top: 12px; left: 12px; z-index: 2000;
    background: var(--danger); border-radius: 50%; width: 16px; height: 16px;
    display: none; box-shadow: 0 0 8px var(--danger);
    animation: pulse 1s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
}

.speed-display { font-size: 11px; color: var(--ok); font-weight: bold; }

table{width:100%; border-collapse:collapse; font-size:10px}
td,th{border-bottom:1px solid var(--line); padding:6px; text-align:center;}
tr.highlight { background: rgba(255, 204, 102, 0.4) !important; transition: background 0.5s; }

@keyframes flashGreen {
    0% { background: rgba(77, 212, 172, 0.6); }
    100% { background: var(--card); }
}
.flash-add { animation: flashGreen 0.5s ease-out; }

.modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; }
.modal-content { background:var(--card); padding:20px; border-radius:15px; text-align:center; width:90%; }
.digit-selector { display:flex; justify-content:center; gap:8px; margin:20px 0; }
.digit-col { display:flex; flex-direction:column; align-items:center; gap:5px; }
.digit-val { font-size:28px; font-family:monospace; font-weight:bold; color:var(--ok); }
.step-btn { background:var(--btn); color:white; border:none; width:35px; height:45px; border-radius:6px; font-size:24px; }
.manual-input { width:80%; padding:10px; margin-top:15px; background:#000; border:1px solid #444; color:var(--ok); text-align:center; font-size:18px; }
.toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#0e1522; border:1px solid var(--line); color:#fff; padding:10px 20px; border-radius:12px; z-index:9999; opacity:0; transition:opacity .2s; pointer-events:none; }
.toast.show{opacity:1}
input[type="text"] { background:var(--btn); border:1px solid #333; color:#fff; padding:4px; border-radius:4px; font-size:10px; width:100%; box-sizing:border-box;}
.photo-icon-div { font-size: 20px; background: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid #2b66ff; color: #2b66ff; }
.danger-btn { background:var(--danger) !important; color:#fff !important; margin-top:10px; padding:8px; border-radius:8px; font-size:11px; font-weight:bold; }
.storage-warn { color: var(--muted); font-size: 9px; margin-top: 5px; }

/* Pulsanti arrotondati (globale) */
button { border-radius: 14px !important; }

/* Pulsante PAUSA/REC: pillola */
#recBtn{
  min-width: 120px;
  height: 46px;
  padding: 0 18px;
  border-radius: 999px !important;
  font-size: 16px;
  font-weight: 800;
  letter-spacing: 1px;
  text-transform: uppercase;
  border: none;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
}

#recBtn.pause{
  background: linear-gradient(180deg, #ffcc66, #e0a800);
  color: #000 !important;
}

#recBtn.rec{
  background: linear-gradient(180deg, #ff4d4d, #c90000);
  color: #fff !important;
  box-shadow:
    0 0 0 3px rgba(255,0,0,0.35),
    0 10px 18px rgba(0,0,0,0.55),
    0 0 18px rgba(255,0,0,0.55);
}

#recBtn.pause::before{ content: "‚ùö‚ùö"; font-size: 14px; line-height: 1; }
#recBtn.rec::before{ content: "‚óè"; font-size: 18px; line-height: 1; animation: rbBlink 1s infinite; }
@keyframes rbBlink{ 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

#recBtn:active{ transform: scale(0.96); box-shadow: 0 2px 6px rgba(0,0,0,0.5); }

</style>
</head>

<body onload="initApp()">

<div class="top-row">
  <div class="ver-badge">v12.3.0-unified</div>
  <div class="card trip-card" id="mainTripBox" onclick="openKmModal()">
    <div class="label">TRIP TOTALE (Hold 3s to Reset)</div>
    <div class="big" id="odoTot">0.000</div>
    <div class="label" style="font-size:9px; margin-top:5px; color:var(--warn)" onclick="event.stopPropagation(); confirmResetGhost()">
        GHOST DIST: <span id="odoGhost">0.000</span> <span style="text-decoration:underline; margin-left:10px;">RESET</span>
    </div>
  </div>
  <div class="photo-btn" onclick="takePhoto()">üì∑</div>
</div>

<div class="card gps-bar">
  <button onclick="setSessionName()" style="font-size:20px; background:none; border:none; color:var(--muted);">‚úèÔ∏è</button>
  <div class="gps-info">
    <span id="fix">WAIT GPS...</span>
    <span id="acc">¬±‚Äî</span>
    <span id="hz">‚Äî Hz</span>
    <span class="speed-display" id="speed">‚Äî km/h</span>
  </div>
  <button id="recBtn" class="pause" onclick="toggleRec()">PAUSA</button>
</div>

<div class="card">
    <div id="map">
        <div id="recIndicator"></div>
        <div id="recenter" onclick="recenter()">üéØ</div>
    </div>
</div>

<div class="card" id="btnParziale" onclick="addPoint()">
  <div class="label">TRIP PARZIALE (TAP = NUOVA NOTA)</div>
  <div class="big" id="odoParz">0.000</div>
</div>

<div class="card" style="overflow-x:auto">
    <table id="mainTable">
        <thead>
            <tr>
                <th>#</th><th>Att</th><th>KM Tot</th><th>KM Parz</th><th>GHOST</th><th>Media</th><th>Ora</th><th>PreRil</th><th>Note</th><th></th>
            </tr>
        </thead>
        <tbody id="pointsBody"></tbody>
    </table>
</div>

<div class="card" style="display:flex; flex-direction:column; gap:10px; padding-bottom:30px;">
  <div id="storageInfo" class="storage-warn" style="text-align:center;"></div>
  <div style="display:flex; gap:10px;">
    <button onclick="exportCSV()" style="flex:1; padding:15px; font-weight:bold;">Excel (CSV)</button>
    <button onclick="exportGPX()" style="flex:1; padding:15px; font-weight:bold;">GPX</button>
    <button onclick="exportZIP()" style="flex:1; padding:15px; font-weight:bold; background:var(--ok); color:#000;">ZIP (KMZ+Foto)</button>
  </div>
  <button class="danger-btn" onclick="clearFullSession()">‚ö†Ô∏è CANCELLA TUTTO E INIZIA NUOVA SESSIONE</button>
</div>

<div id="kmModal" class="modal">
    <div class="modal-content">
        <div class="label">Modifica Cifre</div>
        <div class="digit-selector" id="digitSelectors"></div>
        <input type="number" step="0.001" id="fullKmInput" class="manual-input" oninput="syncDigitsFromInput()">
        <div style="margin-top:12px;">
            <input id="deltaInput" class="manual-input" placeholder="Es: 150 add | -0.15km | +200m">
            <div style="font-size:11px; color:var(--muted); margin-top:6px;">Aggiungi/sottrai una misura mentre il contatore continua a contare. Inserisci valore + 'add'/'sub' oppure prefisso +/-. Se suffisso 'm' = metri, 'km' = chilometri.</div>
        </div>
        <div style="margin-top:12px; display:flex; gap:10px;">
            <button onclick="applyDelta();" style="flex:1; background:#2b66ff; color:#fff; font-weight:bold; height:44px; border-radius:10px;">APPLICA</button>
            <button onclick="saveKmModal()" style="flex:1; background:var(--ok); color:#000; font-weight:bold; height:44px; border-radius:10px;">CONFERMA</button>
            <button onclick="closeKmModal()" style="flex:1; height:44px; border-radius:10px;">ANNULLA</button>
        </div>
    </div>
</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
<div id="toast" class="toast"></div>

<script>
const APP_VERSION = "12.3.0-unified";
const SAVE_INTERVAL_MS = 5000;
const MAX_PHOTOS = 50;
const STORAGE_WARN_MB = 4;

// GPS filters
const GPS_MAX_ACCURACY = 30;      // ignore fix with accuracy > 30m for recording
const GPS_MIN_DISTANCE = 3;       // ignore micro movements < 3m
const GPS_MAX_JUMP = 100;         // ignore jumps > 100m for recording

// Photo compress
const PHOTO_MAX_WIDTH = 1280;
const PHOTO_QUALITY = 0.7;

let state = {
  recording: false, lastFix: null, lastFixTimeMs: null, sessionName: "Roadbook_Log",
  odoTotKm: 0, odoParzKm: 0, odoGhostKm: 0,
  lastPointTime: null, lastPointGhostDist: 0,
  trackSegments: [], points: [], photos: [],
  currentSpeed: 0
};

let runtime = {
  currentPolyline: null, markerByDisplayId: new Map(), trackLines: [], wakeLock: null,
  lastSaveTime: 0
};

const map = L.map("map", { tap: false }).setView([45, 9], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const photoIcon = L.divIcon({ className: '', html: '<div class="photo-icon-div">üì∑</div>', iconSize: [30,30], iconAnchor:[15,15] });

function formatDDM(val, isLat) {
    const absVal = Math.abs(val);
    const d = Math.floor(absVal);
    const m = ((absVal - d) * 60).toFixed(3);
    const hemi = isLat ? (val >= 0 ? 'N' : 'S') : (val >= 0 ? 'E' : 'W');
    return hemi + ' ' + d + ' ' + m;
}

async function initApp() {
    loadState();
    startGPS();
    initLongPress();
    requestWakeLock();
    updateStorageInfo();
    setInterval(function() { if(state.recording) { console.log("KeepAlive_v" + APP_VERSION); } }, 1000);
}

async function requestWakeLock() {
    if ('wakeLock' in navigator) { try { runtime.wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
}

document.addEventListener('visibilitychange', function() { if (document.visibilityState === 'visible') requestWakeLock(); });

function saveState() {
    try {
        localStorage.setItem('rb_logger_state', JSON.stringify(state));
        runtime.lastSaveTime = Date.now();
    } catch(e) {
        if (e && e.name === 'QuotaExceededError') {
            toast("‚ö†Ô∏è Storage pieno! Esporta e cancella.");
        }
    }
}

function loadState() {
    const saved = localStorage.getItem('rb_logger_state');
    if (saved) {
        state = JSON.parse(saved);
        state.recording = false;
        updateUI(); refreshTableUI();
        state.trackSegments.forEach(function(seg) {
            if (seg.length > 1) {
                const line = L.polyline(seg.map(function(p){ return [p.lat,p.lon]; }), {color: "#4dd4ac", weight:4, opacity:0.8}).addTo(map);
                runtime.trackLines.push(line);
            }
        });
        state.photos.forEach(function(ph){ L.marker([ph.lat,ph.lon], {icon:photoIcon}).addTo(map); });
        if (state.points.length > 0) map.setView([state.points[0].lat, state.points[0].lon], 15);
    }
}

function updateStorageInfo() {
    const used = new Blob([JSON.stringify(state)]).size;
    const usedMB = (used / 1024 / 1024).toFixed(2);
    const el = document.getElementById("storageInfo");
    if (usedMB > STORAGE_WARN_MB) { el.textContent = "‚ö†Ô∏è Storage: " + usedMB + " MB / ~5 MB - Esporta presto!"; el.style.color = "var(--danger)"; }
    else if (usedMB > 2) { el.textContent = "Storage: " + usedMB + " MB / ~5 MB"; el.style.color = "var(--warn)"; }
    else { el.textContent = "Storage: " + usedMB + " MB"; el.style.color = "var(--muted)"; }
}

function clearFullSession() {
    if (confirm("CANCELLARE TUTTO?")) { localStorage.removeItem('rb_logger_state'); location.reload(); }
}

function initLongPress() {
    const el = document.getElementById('mainTripBox');
    let timer;
    const start = function() { timer = setTimeout(function(){ state.odoTotKm = 0; state.odoParzKm = 0; updateUI(); saveState(); toast("Trip Reset"); }, 3000); };
    el.ontouchstart = start; el.ontouchend = function(){ clearTimeout(timer); };
    el.onmousedown = start; el.onmouseup = function(){ clearTimeout(timer); };
}

function confirmResetGhost() {
    if (confirm("Azzerare Ghost Distance?")) { state.odoGhostKm = 0; updateUI(); saveState(); toast("Ghost Reset"); }
}

function setSessionName() { var n = prompt("Nome del file:", state.sessionName); if(n) { state.sessionName = n.replace(/\s+/g,'_'); saveState(); } }

function startGPS() { navigator.geolocation.watchPosition(onFix, onGpsError, { enableHighAccuracy: true, maximumAge: 0 }); }

function onGpsError(err) {
    const fixEl = document.getElementById("fix");
    switch(err.code) {
        case 1: fixEl.textContent = "GPS NEGATO"; fixEl.style.color = "var(--danger)"; break;
        case 2: fixEl.textContent = "GPS NON DISP"; fixEl.style.color = "var(--danger)"; break;
        case 3: fixEl.textContent = "GPS TIMEOUT"; fixEl.style.color = "var(--warn)"; break;
        default: fixEl.textContent = "GPS ERR"; fixEl.style.color = "var(--danger)";
    }
}

function onFix(pos) {
    const crd = pos.coords;
    const now = Date.now();

    if (state.lastFixTimeMs) {
        const dt = (now - state.lastFixTimeMs) / 1000;
        document.getElementById("hz").textContent = (1 / dt).toFixed(1) + " Hz";
    }
    state.lastFixTimeMs = now;

    const accEl = document.getElementById("acc");
    accEl.textContent = "¬±" + Math.round(crd.accuracy) + "m";
    if (crd.accuracy > GPS_MAX_ACCURACY) accEl.style.color = "var(--danger)";
    else if (crd.accuracy > 15) accEl.style.color = "var(--warn)";
    else accEl.style.color = "var(--ok)";

    const fixEl = document.getElementById("fix"); fixEl.textContent = "FIX OK"; fixEl.style.color = "var(--ok)";

    if (crd.speed !== null && crd.speed >= 0) { state.currentSpeed = crd.speed * 3.6; }
    document.getElementById("speed").textContent = state.currentSpeed.toFixed(0) + " km/h";

    // Always compute ghost distance when we have lastFix
    if (state.lastFix) {
        const dist = calculateDistance(state.lastFix.lat, state.lastFix.lon, crd.latitude, crd.longitude);
        const dKm = dist / 1000;
        // ghost always counts
        state.odoGhostKm += dKm;

        // apply recording filters for totals
        if (crd.accuracy <= GPS_MAX_ACCURACY) {
            if (dist >= GPS_MIN_DISTANCE && dist <= GPS_MAX_JUMP) {
                if (state.recording) {
                    state.odoTotKm += dKm; state.odoParzKm += dKm;
                    if (runtime.currentPolyline) {
                        const pnt = {lat: crd.latitude, lon: crd.longitude, alt: crd.altitude, timeMs: now};
                        state.trackSegments[state.trackSegments.length-1].push(pnt);
                        runtime.currentPolyline.addLatLng([crd.latitude, crd.longitude]);
                    }
                    if (now - runtime.lastSaveTime > SAVE_INTERVAL_MS) { saveState(); updateStorageInfo(); }
                }
            } else if (dist > GPS_MAX_JUMP) {
                console.log("GPS jump filtrato: " + Math.round(dist) + "m");
                // update lastFix to new location but don't count
                state.lastFix = { lat: crd.latitude, lon: crd.longitude, alt: crd.altitude, timeMs: now };
                return;
            }
        }
        updateUI();
    }

    state.lastFix = { lat: crd.latitude, lon: crd.longitude, alt: crd.altitude, timeMs: now };
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function updateUI() {
    document.getElementById("odoTot").textContent = state.odoTotKm.toFixed(3);
    document.getElementById("odoParz").textContent = state.odoParzKm.toFixed(3);
    document.getElementById("odoGhost").textContent = state.odoGhostKm.toFixed(3);
}

function addPoint() {
    if (!state.lastFix) return;
    const now = Date.now();
    const distFromLast = state.odoGhostKm - state.lastPointGhostDist;
    const timeFromLast = state.lastPointTime ? (now - state.lastPointTime)/3600000 : 0;
    const avg = (timeFromLast > 0 && distFromLast > 0.001) ? (distFromLast/timeFromLast).toFixed(1) : "0.0";

    const p = {
        kmTot: state.odoTotKm, kmParz: state.odoParzKm, odoGhost: state.odoGhostKm,
        avg: avg, time: new Date().toLocaleTimeString(), lat: state.lastFix.lat, lon: state.lastFix.lon,
        alt: state.lastFix.alt ? Math.round(state.lastFix.alt) : 0, att: "", preRil: "", note: ""
    };
    state.points.unshift(p);
    state.lastPointGhostDist = state.odoGhostKm;
    state.lastPointTime = now;
    state.odoParzKm = 0;
    updateUI(); refreshTableUI(); saveState(); updateStorageInfo();

    const card = document.getElementById("btnParziale"); card.classList.add("flash-add"); setTimeout(function(){ card.classList.remove("flash-add"); }, 500);
    toast("üìç Punto #" + state.points.length + " aggiunto");
}

function refreshTableUI() {
    const tb = document.getElementById("pointsBody"); tb.innerHTML = "";
    runtime.markerByDisplayId.forEach(function(m){ map.removeLayer(m); }); runtime.markerByDisplayId.clear();
    let prevTot = 0; const chronPoints = state.points.slice().reverse();
    chronPoints.forEach(function(p,i){ p.kmParz = (i===0)? p.kmTot : (p.kmTot - prevTot); prevTot = p.kmTot; });

    state.points.forEach(function(p,index){
        const displayId = state.points.length - index;
        const m = L.circleMarker([p.lat,p.lon], {radius:7, fillColor:"#4dd4ac", color:"#000", weight:2, fillOpacity:1}).addTo(map);
        m.bindPopup("Punto " + displayId);
        // when marker clicked, highlight row
        m.on('click', function(){ highlightRow(displayId); });
        runtime.markerByDisplayId.set(displayId, m);

        const row = document.createElement('tr'); row.id = 'row-' + displayId;
        row.onclick = function(){ map.setView([p.lat,p.lon], 17); m.openPopup(); highlightRow(displayId); };

        row.innerHTML = '<td>' + displayId + '</td>' +
                        '<td><input type="text" oninput="state.points[' + index + '].att=this.value; saveState()" value="' + p.att + '"></td>' +
                        '<td style="font-weight:bold">' + p.kmTot.toFixed(3) + '</td>' +
                        '<td>' + p.kmParz.toFixed(3) + '</td>' +
                        '<td>' + p.odoGhost.toFixed(3) + '</td>' +
                        '<td style="color:var(--warn)">' + p.avg + '</td>' +
                        '<td>' + p.time + '</td>' +
                        '<td><input type="text" oninput="state.points[' + index + '].preRil=this.value; saveState()" value="' + p.preRil + '"></td>' +
                        '<td><input type="text" oninput="state.points[' + index + '].note=this.value; saveState()" value="' + p.note + '"></td>' +
                        '<td onclick="event.stopPropagation(); deletePoint(' + index + ')">üóë</td>';

        tb.appendChild(row);
    });
}

function highlightRow(displayId) {
    // remove previous
    document.querySelectorAll('tr.highlight').forEach(function(r){ r.classList.remove('highlight'); });
    const el = document.getElementById('row-' + displayId);
    if (el) { el.classList.add('highlight'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
}

function deletePoint(index) { if (confirm('Eliminare?')) { state.points.splice(index,1); refreshTableUI(); saveState(); updateStorageInfo(); } }

function takePhoto() {
    if (!state.lastFix) { toast('‚ö†Ô∏è Attendi fix GPS'); return; }
    if (state.photos.length >= MAX_PHOTOS) { toast('‚ö†Ô∏è Max ' + MAX_PHOTOS + ' foto. Esporta!'); return; }
    document.getElementById('cameraInput').click();
}

document.getElementById('cameraInput').onchange = function(e){
    const file = e.target.files[0]; if (!file) return;
    compressImage(file, function(compressedDataUrl){
        const photo = { lat: state.lastFix.lat, lon: state.lastFix.lon, dataUrl: compressedDataUrl };
        state.photos.push(photo);
        L.marker([photo.lat, photo.lon], {icon:photoIcon}).addTo(map);
        saveState(); updateStorageInfo();
        const sizeKB = Math.round(compressedDataUrl.length * 0.75 / 1024);
        toast('üì∑ Foto ' + state.photos.length + '/' + MAX_PHOTOS + ' (' + sizeKB + 'KB)');
    });
};

function compressImage(file, callback){
    const img = new Image(); const reader = new FileReader();
    reader.onload = function(e){ img.onload = function(){ let width = img.width; let height = img.height; if (width > PHOTO_MAX_WIDTH) { height = Math.round(height * PHOTO_MAX_WIDTH / width); width = PHOTO_MAX_WIDTH; } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,width,height); const compressedDataUrl = canvas.toDataURL('image/jpeg', PHOTO_QUALITY); callback(compressedDataUrl); }; img.src = e.target.result; };
    reader.readAsDataURL(file);
}

function exportCSV() {
    var csv = "ID;ATT;KM_TOT;KM_PARZ;GHOST;MEDIA;ORA;PRERIL;NOTE;ALT;LAT_DEC;LON_DEC;LAT_DDM;LON_DDM\n";
    state.points.slice().reverse().forEach(function(p,i){
        csv += (i+1) + ';' + p.att + ';' + p.kmTot.toFixed(3).replace('.',',') + ';' + p.kmParz.toFixed(3).replace('.',',') + ';' + p.odoGhost.toFixed(3).replace('.',',') + ';' + p.avg + ';' + p.time + ';' + p.preRil + ';' + p.note + ';' + p.alt + ';' + p.lat.toFixed(6).replace('.',',') + ';' + p.lon.toFixed(6).replace('.',',') + ';' + formatDDM(p.lat,true) + ';' + formatDDM(p.lon,false) + '\n';
    });
    const blob = new Blob(['\uFEFF', csv], {type:'text/csv;charset=utf-8'});
    download(blob, state.sessionName + '.csv');
    toast('‚úÖ CSV esportato');
}

async function exportZIP(){
    const zip = new JSZip(); const NT = 'name';
    var kml = '<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n';
    kml += '<' + NT + '>' + escapeXml(state.sessionName) + '</' + NT + '>\n';
    kml += '<Style id="trackStyle"><LineStyle><color>ccdbd44d</color><width>5</width></LineStyle></Style>\n';
    kml += '<Style id="pntIcon"><IconStyle><Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon></IconStyle></Style>\n';
    kml += '<Style id="camIcon"><IconStyle><Icon><href>http://maps.google.com/mapfiles/kml/shapes/camera.png</href></Icon></IconStyle></Style>\n';
    kml += '<Folder><' + NT + '>TRACCE</' + NT + '>\n';
    state.trackSegments.forEach(function(seg,i){ if (seg.length>1){ var coords = seg.map(function(p){ return p.lon+","+p.lat+","+(p.alt||0); }).join(' '); kml += '<Placemark><' + NT + '>T' + (i+1) + '</' + NT + '><styleUrl>#trackStyle</styleUrl><LineString><coordinates>' + coords + '</coordinates></LineString></Placemark>\n'; } });
    kml += '</Folder>\n<Folder><' + NT + '>PUNTI</' + NT + '>\n';
    state.points.slice().reverse().forEach(function(p,i){ kml += '<Placemark><' + NT + '>' + (i+1) + '</' + NT + '><description><![CDATA[KM: ' + p.kmTot.toFixed(3) + '<br>Ora: ' + p.time + '<br>Note: ' + escapeXml(p.note) + ']]></description><styleUrl>#pntIcon</styleUrl><Point><coordinates>' + p.lon + ',' + p.lat + ',' + p.alt + '</coordinates></Point></Placemark>\n'; });
    kml += '</Folder>\n<Folder><' + NT + '>FOTO</' + NT + '>\n';
    state.photos.forEach(function(ph,i){ var fname = 'foto_' + (i+1) + '.jpg'; zip.file('files/' + fname, ph.dataUrl.split(',')[1], {base64:true}); kml += '<Placemark><' + NT + '>F' + (i+1) + '</' + NT + '><styleUrl>#camIcon</styleUrl><description><![CDATA[<img src="files/' + fname + '" width="400"/>]]></description><Point><coordinates>' + ph.lon + ',' + ph.lat + ',0</coordinates></Point></Placemark>\n'; });
    kml += '</Folder>\n</Document>\n</kml>';
    zip.file(state.sessionName + '.kml', kml);
    const content = await zip.generateAsync({type:'blob'});
    download(content, state.sessionName + '.zip');
    toast('‚úÖ ZIP esportato');
}

function exportGPX(){
    const NT = 'name'; var gpx = '<?xml version="1.0" encoding="UTF-8"?>\n';
    gpx += '<gpx version="1.1" creator="Roadbook Logger Pro ' + APP_VERSION + '" xmlns="http://www.topografix.com/GPX/1/1">\n';
    gpx += '<metadata><' + NT + '>' + escapeXml(state.sessionName) + '</' + NT + '><time>' + new Date().toISOString() + '</time></metadata>\n';
    state.points.slice().reverse().forEach(function(p,i){ gpx += '<wpt lat="' + p.lat + '" lon="' + p.lon + '"><ele>' + p.alt + '</ele><' + NT + '>' + (i+1) + '</' + NT + '><desc>KM: ' + p.kmTot.toFixed(3) + ', ' + escapeXml(p.note) + '</desc></wpt>\n'; });
    if (state.trackSegments.some(function(s){ return s.length > 1; })){
        gpx += '<trk><' + NT + '>' + escapeXml(state.sessionName) + '</' + NT + '>\n';
        state.trackSegments.forEach(function(seg){ if (seg.length>1){ gpx += '<trkseg>\n'; seg.forEach(function(p){ gpx += '<trkpt lat="' + p.lat + '" lon="' + p.lon + '"><ele>' + (p.alt||0) + '</ele><time>' + new Date(p.timeMs).toISOString() + '</time></trkpt>\n'; }); gpx += '</trkseg>\n'; } });
        gpx += '</trk>\n';
    }
    gpx += '</gpx>';
    download(new Blob([gpx], {type:'application/gpx+xml'}), state.sessionName + '.gpx');
    toast('‚úÖ GPX esportato');
}

function escapeXml(str){ if (!str) return ''; return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function download(blob, name){ const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href); }

function openKmModal(){ const val = state.odoTotKm.toFixed(3).padStart(7,'0'); document.getElementById('fullKmInput').value = state.odoTotKm.toFixed(3); renderDigitSelectors(val); document.getElementById('kmModal').style.display = 'flex'; }

function renderDigitSelectors(val){ const container = document.getElementById('digitSelectors'); container.innerHTML = ''; var digitIdx = 0; val.split('').forEach(function(char){ if (char === '.') container.insertAdjacentHTML('beforeend','<div class="digit-val">.</div>'); else { const i = digitIdx; container.insertAdjacentHTML('beforeend','<div class="digit-col"><button class="step-btn" onclick="stepDigit(' + i + ',1)">+</button><div class="digit-val" id="digit-' + i + '">' + char + '</div><button class="step-btn" onclick="stepDigit(' + i + ',-1)">-</button></div>'); digitIdx++; } }); }

function stepDigit(idx, delta){ const el = document.getElementById('digit-' + idx); el.innerText = (parseInt(el.innerText) + delta + 10) % 10; syncInputFromDigits(); }

function syncInputFromDigits(){ var s = ''; var digitIdx = 0; const currentVal = parseFloat(document.getElementById('fullKmInput').value || 0).toFixed(3).padStart(7,'0'); currentVal.split('').forEach(function(char){ if (char === '.') s += '.'; else { s += document.getElementById('digit-' + digitIdx).innerText; digitIdx++; } }); document.getElementById('fullKmInput').value = parseFloat(s).toFixed(3); }

function syncDigitsFromInput(){ const val = parseFloat(document.getElementById('fullKmInput').value || 0).toFixed(3).padStart(7,'0'); renderDigitSelectors(val); }

function saveKmModal(){ state.odoTotKm = parseFloat(document.getElementById('fullKmInput').value); updateUI(); saveState(); closeKmModal(); }
function closeKmModal(){ document.getElementById('kmModal').style.display = 'none'; }

function parseDeltaInput(text){ if (!text) return null; text = text.trim().toLowerCase(); // examples: "150 add", "-0.15km", "+200m"
    // direct +/- with unit
    const plusMinusMatch = text.match(/^([+-]?\d*\.?\d+)\s*(km|m)?$/);
    if (plusMinusMatch){ const num = parseFloat(plusMinusMatch[1]); const unit = plusMinusMatch[2] || 'm'; const km = (unit === 'km') ? num : num/1000; return km; }
    // with operation
    const parts = text.split(/\s+/);
    if (parts.length === 2){ let amt = parseFloat(parts[0]); if (isNaN(amt)) return null; const op = parts[1]; // default meters
        if (parts[0].toLowerCase().endsWith('km')){ amt = parseFloat(parts[0]); return amt; }
        if (parts[0].toLowerCase().endsWith('m')){ amt = parseFloat(parts[0]); return amt/1000; }
        if (op === 'add' || op === '+' ) return amt/1000; if (op === 'sub' || op === 'remove' || op === '-') return -amt/1000; // assume meters
    }
    return null;
}

function applyDelta(){ const txt = document.getElementById('deltaInput').value; if (!txt) { toast('Inserisci valore da applicare'); return; } let km = parseDeltaInput(txt); if (km === null){ // try pattern like '150 add'
        const m = txt.match(/(\d+\.?\d*)\s*(m|km)?\s*(add|sub|\+|\-)?/);
        if (m){ let amt = parseFloat(m[1]); const unit = m[2]; const op = m[3]; if (unit === 'km') km = amt; else km = amt/1000; if (op === 'sub' || op === '-') km = -Math.abs(km); }
    }
    if (km === null) { toast('Formato non riconosciuto'); return; }
    state.odoTotKm = Math.max(0, state.odoTotKm + km); updateUI(); saveState(); toast('Aggiornato: ' + (km>=0?'+':'') + (km*1000).toFixed(0) + ' m'); document.getElementById('deltaInput').value = ''; }

function toggleRec(){ state.recording = !state.recording; document.getElementById('recBtn').textContent = state.recording ? 'REC' : 'PAUSA'; document.getElementById('recBtn').className = state.recording ? 'rec' : 'pause'; document.getElementById('recIndicator').style.display = state.recording ? 'block' : 'none'; if (state.recording){ state.trackSegments.push([]); runtime.currentPolyline = L.polyline([], {color:'#4dd4ac', weight:4, opacity:0.8}).addTo(map); runtime.trackLines.push(runtime.currentPolyline); toast('‚ñ∂Ô∏è Registrazione attiva'); } else { toast('‚è∏Ô∏è Pausa'); } saveState(); }

function toast(m){ var t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(function(){ t.classList.remove('show'); }, 2000); }

function recenter(){ if (state.lastFix) map.setView([state.lastFix.lat, state.lastFix.lon], 16); }

</script>
</body>
</html>
