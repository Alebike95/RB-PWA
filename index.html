<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
<title>Roadbook Logger Pro v4</title>

<meta name="theme-color" content="#0b0f14">
<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{
  --bg:#0b0f14; --card:#121826; --muted:#9fb0c3; --btn:#1b2536;
  --line:#223; --ok:#4dd4ac; --warn:#ffcc66; --danger:#ff6b6b;
}
body{margin:0;background:var(--bg);color:#e8eef6;font-family:system-ui;user-select:none;touch-action:manipulation;}
.card{background:var(--card);border-radius:14px;padding:10px;margin:8px}
.top-row{display:flex;gap:8px;align-items:stretch}
.trip-card{flex:1; cursor:pointer;}
.photo-btn{ width:56px; background:var(--btn); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:26px; }
.big{ font-size:52px; font-family:monospace; line-height:1; text-align:right; padding-right:1ch; color:#fff; }
.label{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;}
.gps-bar{display:flex; align-items:center; gap:8px}
.gps-info{flex:1; display:flex; gap:10px; justify-content:center; font-size:11px;}
#recBtn.rec{color:var(--ok); font-weight:bold;}
#recBtn.pause{color:var(--warn)}
#map{height:250px; border-radius:14px; position:relative}
#recenter{ position:absolute; bottom:12px; right:12px; z-index:2000; background:var(--btn); border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-size:20px; }
table{width:100%; border-collapse:collapse; font-size:10px}
td,th{border-bottom:1px solid var(--line); padding:6px; text-align:center;}
tr.highlight { background: rgba(77, 212, 172, 0.2); transition: background 0.5s; }

.modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; }
.modal-content { background:var(--card); padding:20px; border-radius:15px; text-align:center; width:90%; }
.digit-selector { display:flex; justify-content:center; gap:8px; margin:20px 0; }
.digit-col { display:flex; flex-direction:column; align-items:center; gap:5px; }
.digit-val { font-size:28px; font-family:monospace; font-weight:bold; color:var(--ok); }
.step-btn { background:var(--btn); color:white; border:none; width:35px; height:45px; border-radius:6px; font-size:24px; }
.manual-input { width:80%; padding:10px; margin-top:15px; background:#000; border:1px solid #444; color:var(--ok); text-align:center; font-size:18px; }
.toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#0e1522; border:1px solid var(--line); color:#fff; padding:10px 20px; border-radius:12px; z-index:9999; opacity:0; transition:opacity .2s; pointer-events:none; }
.toast.show{opacity:1}
input[type="text"] { background:var(--btn); border:1px solid #333; color:#fff; padding:4px; border-radius:4px; font-size:10px; width:100%; box-sizing:border-box;}
</style>
</head>

<body onload="initApp()">

<div class="top-row">
  <div class="card trip-card" id="mainTripBox" onclick="openKmModal()">
    <div class="label">TRIP TOTALE (Hold 3s to Reset)</div>
    <div class="big" id="odoTot">0.000</div>
    <div class="label" style="font-size:9px; margin-top:5px; color:var(--warn)" onclick="event.stopPropagation(); resetGhost()">
        GHOST DIST: <span id="odoGhost">0.000</span> <span style="text-decoration:underline; margin-left:10px;">RESET</span>
    </div>
  </div>
  <div class="photo-btn" onclick="takePhoto()">üì∑</div>
</div>

<div class="card gps-bar">
  <button onclick="setSessionName()" style="font-size:20px; background:none; border:none; color:var(--muted);">‚úèÔ∏è</button>
  <div class="gps-info">
    <span id="fix">WAIT GPS...</span> <span id="acc">¬±‚Äî</span> <span id="hz">‚Äî Hz</span>
  </div>
  <button id="recBtn" class="pause" onclick="toggleRec()">PAUSA</button>
</div>

<div class="card"><div id="map"><div id="recenter" onclick="recenter()">üéØ</div></div></div>

<div class="card" onclick="addPoint()">
  <div class="label">TRIP PARZIALE (TAP = NUOVA NOTA)</div>
  <div class="big" id="odoParz">0.000</div>
</div>

<div class="card" style="overflow-x:auto">
    <table id="mainTable">
        <thead>
            <tr>
                <th>#</th><th>Att</th><th>KM Tot</th><th>KM Parz</th><th>Media</th><th>Ora</th><th>PreRil</th><th>Note</th><th></th>
            </tr>
        </thead>
        <tbody id="points"></tbody>
    </table>
</div>

<div class="card" style="display:flex; gap:10px;">
  <button onclick="exportCSV()" style="flex:1; padding:12px;">Excel (CSV)</button>
  <button onclick="exportGPX()" style="flex:1; padding:12px;">GPX</button>
  <button onclick="exportKMZ()" style="flex:1; padding:12px;">KMZ</button>
</div>

<div id="kmModal" class="modal">
    <div class="modal-content">
        <div class="label">Modifica Cifre</div>
        <div class="digit-selector" id="digitSelectors"></div>
        <input type="number" step="0.001" id="fullKmInput" class="manual-input">
        <div style="margin-top:25px; display:flex; gap:10px;">
            <button onclick="saveKmModal()" style="flex:1; background:var(--ok); color:#000; font-weight:bold; height:50px; border-radius:10px;">CONFERMA</button>
            <button onclick="closeKmModal()" style="flex:1; height:50px; border-radius:10px;">ANNULLA</button>
        </div>
    </div>
</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
<div id="toast" class="toast"></div>

<script>
const state = {
  recording: false, lastFix: null, lastFixTimeMs: null, sessionName: "Roadbook_Log",
  odoTotKm: 0, odoParzKm: 0, odoGhostKm: 0,
  lastPointTime: null, lastPointGhostDist: 0,
  trackSegments: [], currentSegment: null, trackLines: [],
  points: [], photos: [], 
  markerByPointId: new Map()
};

const map = L.map("map").setView([45, 9], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

function initApp() {
    startGPS();
    initLongPress();
}

// RESET TOTALE 3 SECONDI
function initLongPress() {
    const el = document.getElementById('mainTripBox');
    let timer;
    const start = (e) => {
        timer = setTimeout(() => {
            state.odoTotKm = 0;
            updateUI();
            if(navigator.vibrate) navigator.vibrate(200);
            toast("Trip Totale Azzerato");
        }, 3000);
    };
    const end = () => clearTimeout(timer);
    el.addEventListener('touchstart', start);
    el.addEventListener('touchend', end);
    el.addEventListener('mousedown', start);
    el.addEventListener('mouseup', end);
}

function setSessionName() {
    let n = prompt("Nome del file esportazione:", state.sessionName);
    if(n) state.sessionName = n.replace(/\s+/g, '_');
}

function resetGhost() {
    if(confirm("Vuoi azzerare il Ghost Trip per il calcolo delle medie?")) {
        state.odoGhostKm = 0;
        state.lastPointGhostDist = 0;
        updateUI();
    }
}

function startGPS() {
    navigator.geolocation.watchPosition(onFix, (e) => console.log(e), { enableHighAccuracy: true, maximumAge: 0 });
    if ('wakeLock' in navigator) navigator.wakeLock.request('screen');
}

function onFix(pos) {
    const crd = pos.coords;
    const now = Date.now();
    if (state.lastFixTimeMs) {
        document.getElementById("hz").textContent = (1000 / (now - state.lastFixTimeMs)).toFixed(1) + " Hz";
    }
    state.lastFixTimeMs = now;
    document.getElementById("acc").textContent = "¬±" + Math.round(crd.accuracy) + "m";
    document.getElementById("fix").textContent = "FIX OK";

    if (state.lastFix) {
        let dist = calculateDistance(state.lastFix.lat, state.lastFix.lon, crd.latitude, crd.longitude);
        if (crd.speed > 0.22 || (crd.accuracy < 10 && dist > 0.05)) {
            let dKm = dist / 1000;
            state.odoGhostKm += dKm;
            if (state.recording) {
                state.odoTotKm += dKm;
                state.odoParzKm += dKm;
                if (state.currentSegment) {
                    state.currentSegment.push({lat: crd.latitude, lon: crd.longitude, alt: crd.altitude, timeMs: now});
                    state.trackLines[state.trackLines.length-1].addLatLng([crd.latitude, crd.longitude]);
                }
            }
            updateUI();
        }
    }
    state.lastFix = { lat: crd.latitude, lon: crd.longitude, alt: crd.altitude, timeMs: now };
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// FORMATO RICHIESTO: N46 12.345
function formatDMS(val, isLat) {
    const absVal = Math.abs(val);
    const d = Math.floor(absVal);
    const m = ((absVal - d) * 60).toFixed(3);
    const hemi = isLat ? (val >= 0 ? 'N' : 'S') : (val >= 0 ? 'E' : 'W');
    return `${hemi}${d} ${m}`;
}

function updateUI() {
    document.getElementById("odoTot").textContent = state.odoTotKm.toFixed(3);
    document.getElementById("odoParz").textContent = state.odoParzKm.toFixed(3);
    document.getElementById("odoGhost").textContent = state.odoGhostKm.toFixed(3);
}

function addPoint() {
    if (!state.lastFix) return toast("No GPS Fix");
    let now = Date.now();
    let distFromLast = state.odoGhostKm - state.lastPointGhostDist;
    let timeFromLast = state.lastPointTime ? (now - state.lastPointTime) / 3600000 : 0;
    let avg = (timeFromLast > 0) ? (distFromLast / timeFromLast).toFixed(1) : "0.0";

    const p = {
        kmTot: state.odoTotKm, kmParz: state.odoParzKm,
        avg: avg, time: new Date().toLocaleTimeString(),
        lat: state.lastFix.lat, lon: state.lastFix.lon, 
        alt: state.lastFix.alt ? Math.round(state.lastFix.alt) : 0,
        att: "", preRil: "", note: ""
    };

    state.points.unshift(p);
    state.lastPointGhostDist = state.odoGhostKm;
    state.lastPointTime = now;
    state.odoParzKm = 0;
    
    updateUI();
    renderTable();
}

function renderTable() {
    const tb = document.getElementById("points");
    state.markerByPointId.forEach(m => map.removeLayer(m));
    state.markerByPointId.clear();

    tb.innerHTML = state.points.map((p, index) => {
        let displayId = state.points.length - index; 
        const m = L.circleMarker([p.lat, p.lon], {radius:7, fillColor:"#4dd4ac", color:"#000", weight:2, fillOpacity:1}).addTo(map);
        m.bindPopup(`Punto ${displayId}`);
        m.on('click', () => highlightRow(displayId));
        state.markerByPointId.set(displayId, m);

        return `
            <tr id="row-${displayId}" onclick="focusMap(${p.lat}, ${p.lon}, ${displayId})">
                <td>${displayId}</td>
                <td><input type="text" oninput="state.points[${index}].att=this.value" value="${p.att}"></td>
                <td style="font-weight:bold">${p.kmTot.toFixed(3)}</td>
                <td>${p.kmParz.toFixed(3)}</td>
                <td style="color:var(--warn)">${p.avg}</td>
                <td>${p.time}</td>
                <td><input type="text" oninput="state.points[${index}].preRil=this.value" value="${p.preRil}"></td>
                <td><input type="text" oninput="state.points[${index}].note=this.value" value="${p.note}"></td>
                <td onclick="event.stopPropagation(); deletePoint(${index})">üóë</td>
            </tr>
        `;
    }).join('');
}

function focusMap(lat, lon, id) {
    map.setView([lat, lon], 17);
    state.markerByPointId.get(id).openPopup();
}

function highlightRow(id) {
    const el = document.getElementById(`row-${id}`);
    if(el) {
        el.scrollIntoView({behavior:'smooth', block:'center'});
        el.classList.add('highlight');
        setTimeout(() => el.classList.remove('highlight'), 2000);
    }
}

function deletePoint(index) {
    state.points.splice(index, 1);
    renderTable();
}

function takePhoto() {
    if (!state.lastFix) return toast("No GPS");
    document.getElementById("cameraInput").click();
}

document.getElementById("cameraInput").onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        const photo = { lat:state.lastFix.lat, lon:state.lastFix.lon, dataUrl:reader.result };
        state.photos.push(photo);
        L.marker([photo.lat, photo.lon]).addTo(map);
        toast("Foto Salvata");
    };
    reader.readAsDataURL(file);
};

// EXPORT EXCEL CON FORMATO RICHIESTO
function exportCSV() {
    let csv = "ID;ATT;KM_TOT;KM_PARZ;MEDIA;ORA;PRERIL;NOTE;ALTITUDINE;LAT_DEC;LON_DEC;LAT_DMS;LON_DMS\n";
    state.points.slice().reverse().forEach((p, i) => {
        let latDec = p.lat.toFixed(6).replace('.', ',');
        let lonDec = p.lon.toFixed(6).replace('.', ',');
        csv += `${i+1};${p.att};${p.kmTot.toFixed(3).replace('.',',')};${p.kmParz.toFixed(3).replace('.',',')};${p.avg};${p.time};${p.preRil};${p.note};${p.alt};${latDec};${lonDec};${formatDMS(p.lat,true)};${formatDMS(p.lon,false)}\n`;
    });
    download(csv, state.sessionName + ".csv", "text/csv");
}

async function exportKMZ() {
    const zip = new JSZip();
    let kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>${state.sessionName}</name>`;
    state.points.forEach((p, i) => {
        kml += `<Placemark><name>Punto ${state.points.length-i}</name><Point><coordinates>${p.lon},${p.lat},${p.alt}</coordinates></Point></Placemark>`;
    });
    state.photos.forEach((ph, i) => {
        const name = `foto_${i}.jpg`;
        zip.file("files/"+name, ph.dataUrl.split(',')[1], {base64:true});
        kml += `<Placemark><name>Foto ${i}</name><description><![CDATA[<img src="files/${name}" width="300"/>]]></description><Point><coordinates>${ph.lon},${ph.lat},0</coordinates></Point></Placemark>`;
    });
    kml += `</Document></kml>`;
    zip.file("doc.kml", kml);
    const content = await zip.generateAsync({type:"blob"});
    download(content, state.sessionName + ".kmz", "application/vnd.google-earth.kmz");
}

function exportGPX() {
    let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" xmlns="http://www.topografix.com/GPX/1/1">`;
    state.points.forEach((p, i) => { gpx += `<wpt lat="${p.lat}" lon="${p.lon}"><ele>${p.alt}</ele><name>Punto ${state.points.length-i}</name></wpt>`; });
    gpx += `</gpx>`;
    download(gpx, state.sessionName + ".gpx", "application/gpx+xml");
}

function download(content, name, type) {
    const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([content], {type})); a.download = name; a.click();
}

function openKmModal() {
    const val = state.odoTotKm.toFixed(3).padStart(7, '0');
    document.getElementById("fullKmInput").value = state.odoTotKm.toFixed(3);
    const container = document.getElementById("digitSelectors");
    container.innerHTML = '';
    let digitIdx = 0;
    [...val].forEach((char) => {
        if(char === '.') {
            container.insertAdjacentHTML('beforeend', '<div class="digit-val">.</div>');
        } else {
            const i = digitIdx;
            container.insertAdjacentHTML('beforeend', `<div class="digit-col"><button class="step-btn" onclick="stepDigit(${i}, 1)">+</button><div class="digit-val" id="digit-${i}">${char}</div><button class="step-btn" onclick="stepDigit(${i}, -1)">-</button></div>`);
            digitIdx++;
        }
    });
    document.getElementById("kmModal").style.display = 'flex';
}
function stepDigit(idx, delta) {
    const el = document.getElementById(`digit-${idx}`);
    el.innerText = (parseInt(el.innerText) + delta + 10) % 10;
}
function saveKmModal() {
    state.odoTotKm = parseFloat(document.getElementById("fullKmInput").value);
    updateUI(); closeKmModal();
}
function closeKmModal() { document.getElementById("kmModal").style.display = 'none'; }
function toggleRec() {
    state.recording = !state.recording;
    document.getElementById("recBtn").textContent = state.recording ? "REC" : "PAUSA";
    document.getElementById("recBtn").className = state.recording ? "rec" : "pause";
    if (state.recording) {
        state.currentSegment = [];
        state.trackSegments.push(state.currentSegment);
        state.trackLines.push(L.polyline([], {color: "#4dd4ac", weight:4}).addTo(map));
    }
}
function toast(m) { let t = document.getElementById("toast"); t.textContent = m; t.classList.add("show"); setTimeout(() => t.classList.remove("show"), 2000); }
function recenter() { if(state.lastFix) map.setView([state.lastFix.lat, state.lastFix.lon], 16); }
</script>
</body>
</html>
