<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=yes">
<title>Roadbook Logger Pro v12.1</title>

<meta name="theme-color" content="#0b0f14">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{
  --bg:#0b0f14; --card:#121826; --muted:#9fb0c3; --btn:#1b2536;
  --line:#223; --ok:#4dd4ac; --warn:#ffcc66; --danger:#ff6b6b;
}
html, body { 
    height: 100%; overflow-y: auto !important; 
    overscroll-behavior-y: contain !important;
    touch-action: pan-y !important; 
    margin:0; background:var(--bg); color:#e8eef6; font-family:system-ui; user-select:none;
}
.card{background:var(--card);border-radius:14px;padding:10px;margin:8px; touch-action: auto;}
.top-row{display:flex;gap:8px;align-items:stretch}
.trip-card{flex:1; cursor:pointer;}
.photo-btn{ width:56px; background:var(--btn); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:26px; }
.big{ font-size:52px; font-family:monospace; line-height:1; text-align:right; padding-right:1ch; color:#fff; }
.label{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;}
.gps-bar{display:flex; align-items:center; gap:8px}
.gps-info{flex:1; display:flex; gap:10px; justify-content:center; font-size:11px;}
#recBtn.rec{color:var(--ok); font-weight:bold;}
#recBtn.pause{color:var(--warn)}
#map{height:250px; border-radius:14px; position:relative; touch-action: none;}
#recenter{ position:absolute; bottom:12px; right:12px; z-index:2000; background:var(--btn); border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-size:20px; }
table{width:100%; border-collapse:collapse; font-size:10px}
td,th{border-bottom:1px solid var(--line); padding:6px; text-align:center;}
tr.highlight { background: rgba(255, 204, 102, 0.4) !important; transition: background 0.5s; }
.modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; }
.modal-content { background:var(--card); padding:20px; border-radius:15px; text-align:center; width:90%; }
.digit-selector { display:flex; justify-content:center; gap:8px; margin:20px 0; }
.digit-col { display:flex; flex-direction:column; align-items:center; gap:5px; }
.digit-val { font-size:28px; font-family:monospace; font-weight:bold; color:var(--ok); }
.step-btn { background:var(--btn); color:white; border:none; width:35px; height:45px; border-radius:6px; font-size:24px; }
.manual-input { width:80%; padding:10px; margin-top:15px; background:#000; border:1px solid #444; color:var(--ok); text-align:center; font-size:18px; }
.toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#0e1522; border:1px solid var(--line); color:#fff; padding:10px 20px; border-radius:12px; z-index:9999; opacity:0; transition:opacity .2s; pointer-events:none; }
.toast.show{opacity:1}
input[type="text"] { background:var(--btn); border:1px solid #333; color:#fff; padding:4px; border-radius:4px; font-size:10px; width:100%; box-sizing:border-box;}
.photo-icon-div { font-size: 20px; background: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid #2b66ff; color: #2b66ff; }
.danger-btn { background:var(--danger) !important; color:#fff !important; margin-top:20px; padding:10px; border-radius:8px; font-size:11px; font-weight:bold; }
</style>
</head>

<body onload="initApp()">

<div class="top-row">
  <div class="card trip-card" id="mainTripBox" onclick="openKmModal()">
    <div class="label">TRIP TOTALE (Hold 3s to Reset)</div>
    <div class="big" id="odoTot">0.000</div>
    <div class="label" style="font-size:9px; margin-top:5px; color:var(--warn)" onclick="event.stopPropagation(); resetGhost()">
        GHOST DIST: <span id="odoGhost">0.000</span> <span style="text-decoration:underline; margin-left:10px;">RESET</span>
    </div>
  </div>
  <div class="photo-btn" onclick="takePhoto()">üì∑</div>
</div>

<div class="card gps-bar">
  <button onclick="setSessionName()" style="font-size:20px; background:none; border:none; color:var(--muted);">‚úèÔ∏è</button>
  <div class="gps-info">
    <span id="fix">WAIT GPS...</span> <span id="acc">¬±‚Äî</span> <span id="hz">‚Äî Hz</span>
  </div>
  <button id="recBtn" class="pause" onclick="toggleRec()">PAUSA</button>
</div>

<div class="card"><div id="map"><div id="recenter" onclick="recenter()">üéØ</div></div></div>

<div class="card" id="btnParziale" onclick="addPoint()">
  <div class="label">TRIP PARZIALE (TAP = NUOVA NOTA)</div>
  <div class="big" id="odoParz">0.000</div>
</div>

<div class="card" style="overflow-x:auto">
    <table id="mainTable">
        <thead>
            <tr>
                <th>#</th><th>Att</th><th>KM Tot</th><th>KM Parz</th><th>Media</th><th>Ora</th><th>PreRil</th><th>Note</th><th></th>
            </tr>
        </thead>
        <tbody id="pointsBody"></tbody>
    </table>
</div>

<div class="card" style="display:flex; flex-direction:column; gap:10px; padding-bottom:30px;">
  <div style="display:flex; gap:10px;">
    <button onclick="exportCSV()" style="flex:1; padding:15px; font-weight:bold;">Excel (CSV)</button>
    <button onclick="exportGPX()" style="flex:1; padding:15px; font-weight:bold;">GPX</button>
    <button onclick="exportZIP()" style="flex:1; padding:15px; font-weight:bold; background:var(--ok); color:#000;">ZIP (KMZ+Foto)</button>
  </div>
  <button class="danger-btn" onclick="clearFullSession()">‚ö†Ô∏è CANCELLA TUTTO E INIZIA NUOVA SESSIONE</button>
</div>

<div id="kmModal" class="modal">
    <div class="modal-content">
        <div class="label">Modifica Cifre</div>
        <div class="digit-selector" id="digitSelectors"></div>
        <input type="number" step="0.001" id="fullKmInput" class="manual-input" oninput="syncDigitsFromInput()">
        <div style="margin-top:25px; display:flex; gap:10px;">
            <button onclick="saveKmModal()" style="flex:1; background:var(--ok); color:#000; font-weight:bold; height:50px; border-radius:10px;">CONFERMA</button>
            <button onclick="closeKmModal()" style="flex:1; height:50px; border-radius:10px;">ANNULLA</button>
        </div>
    </div>
</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
<div id="toast" class="toast"></div>

<script>
let state = {
  recording: false, lastFix: null, lastFixTimeMs: null, sessionName: "Roadbook_Log",
  odoTotKm: 0, odoParzKm: 0, odoGhostKm: 0,
  lastPointTime: null, lastPointGhostDist: 0,
  trackSegments: [], points: [], photos: []
};

let runtime = {
  currentPolyline: null, markerByDisplayId: new Map(), trackLines: [], wakeLock: null
};

const map = L.map("map", { tap: false }).setView([45, 9], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const photoIcon = L.divIcon({
    className: '',
    html: '<div class="photo-icon-div">üì∑</div>',
    iconSize: [30, 30], iconAnchor: [15, 15]
});

// FORMATO RICHIESTO: N46 12.345 (Gradi Minuti Decimali)
function formatDDM(val, isLat) {
    const absVal = Math.abs(val);
    const d = Math.floor(absVal);
    const m = ((absVal - d) * 60).toFixed(3);
    const hemi = isLat ? (val >= 0 ? 'N' : 'S') : (val >= 0 ? 'E' : 'W');
    return `${hemi}${d} ${m}`;
}

async function initApp() {
    loadState();
    startGPS();
    initLongPress();
    requestWakeLock();
    
    // TRUCCO BACKGROUND: Un loop invisibile che tiene sveglio il processo
    setInterval(() => { if(state.recording) { console.log("KeepAlive"); } }, 1000);
}

async function requestWakeLock() {
    if ('wakeLock' in navigator) {
        try { runtime.wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }
}

document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') requestWakeLock();
});

function saveState() {
    localStorage.setItem('rb_logger_state', JSON.stringify(state));
}

function loadState() {
    const saved = localStorage.getItem('rb_logger_state');
    if (saved) {
        state = JSON.parse(saved);
        state.recording = false; 
        updateUI(); refreshTableUI();
        state.trackSegments.forEach(seg => {
            if(seg.length > 1) {
                const line = L.polyline(seg.map(p => [p.lat, p.lon]), {color: "#4dd4ac", weight:4, opacity: 0.8}).addTo(map);
                runtime.trackLines.push(line);
            }
        });
        state.photos.forEach(ph => { L.marker([ph.lat, ph.lon], {icon: photoIcon}).addTo(map); });
        if(state.points.length > 0) map.setView([state.points[0].lat, state.points[0].lon], 15);
    }
}

function clearFullSession() {
    if(confirm("CANCELLARE TUTTO?")) { localStorage.removeItem('rb_logger_state'); location.reload(); }
}

function initLongPress() {
    const el = document.getElementById('mainTripBox');
    let timer;
    const start = () => { timer = setTimeout(() => { 
        state.odoTotKm = 0; state.odoParzKm = 0; 
        updateUI(); saveState(); toast("Trip Reset"); 
    }, 2000); };
    el.ontouchstart = start; el.ontouchend = () => clearTimeout(timer);
}

function setSessionName() {
    let n = prompt("Nome del file:", state.sessionName);
    if(n) { state.sessionName = n.replace(/\s+/g, '_'); saveState(); }
}

function startGPS() {
    navigator.geolocation.watchPosition(onFix, null, { enableHighAccuracy: true, maximumAge: 0 });
}

function onFix(pos) {
    const crd = pos.coords;
    const now = Date.now();
    if (state.lastFixTimeMs) document.getElementById("hz").textContent = (1000 / (now - state.lastFixTimeMs)).toFixed(1) + " Hz";
    state.lastFixTimeMs = now;
    document.getElementById("acc").textContent = "¬±" + Math.round(crd.accuracy) + "m";
    document.getElementById("fix").textContent = "FIX OK";

    if (state.lastFix) {
        let dist = calculateDistance(state.lastFix.lat, state.lastFix.lon, crd.latitude, crd.longitude);
        let dKm = dist / 1000;
        state.odoGhostKm += dKm;
        if (state.recording) {
            state.odoTotKm += dKm; state.odoParzKm += dKm;
            if (runtime.currentPolyline) {
                const pnt = {lat: crd.latitude, lon: crd.longitude, alt: crd.altitude, timeMs: now};
                state.trackSegments[state.trackSegments.length-1].push(pnt);
                runtime.currentPolyline.addLatLng([crd.latitude, crd.longitude]);
            }
            if(Math.random() > 0.98) saveState(); 
        }
        updateUI();
    }
    state.lastFix = { lat: crd.latitude, lon: crd.longitude, alt: crd.altitude, timeMs: now };
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function updateUI() {
    document.getElementById("odoTot").textContent = state.odoTotKm.toFixed(3);
    document.getElementById("odoParz").textContent = state.odoParzKm.toFixed(3);
    document.getElementById("odoGhost").textContent = state.odoGhostKm.toFixed(3);
}

function addPoint() {
    if (!state.lastFix) return;
    let now = Date.now();
    let distFromLast = state.odoGhostKm - state.lastPointGhostDist;
    let timeFromLast = state.lastPointTime ? (now - state.lastPointTime)/3600000 : 0;
    let avg = (timeFromLast > 0 && distFromLast > 0.001) ? (distFromLast/timeFromLast).toFixed(1) : "0.0";

    const p = {
        kmTot: state.odoTotKm, kmParz: state.odoParzKm, odoGhost: state.odoGhostKm,
        avg, time: new Date().toLocaleTimeString(),
        lat: state.lastFix.lat, lon: state.lastFix.lon, 
        alt: state.lastFix.alt ? Math.round(state.lastFix.alt) : 0,
        att: "", preRil: "", note: ""
    };
    state.points.unshift(p);
    state.lastPointGhostDist = state.odoGhostKm;
    state.lastPointTime = now;
    state.odoParzKm = 0;
    updateUI(); refreshTableUI(); saveState();
}

function refreshTableUI() {
    const tb = document.getElementById("pointsBody");
    tb.innerHTML = "";
    runtime.markerByDisplayId.forEach(m => map.removeLayer(m));
    runtime.markerByDisplayId.clear();
    let prevTot = 0;
    const chronPoints = [...state.points].reverse();
    chronPoints.forEach((p, i) => {
        p.kmParz = (i === 0) ? p.kmTot : (p.kmTot - prevTot);
        prevTot = p.kmTot;
    });
    state.points.forEach((p, index) => {
        const displayId = state.points.length - index;
        const m = L.circleMarker([p.lat, p.lon], {radius:7, fillColor:"#4dd4ac", color:"#000", weight:2, fillOpacity:1}).addTo(map);
        m.bindPopup("Punto " + displayId);
        runtime.markerByDisplayId.set(displayId, m);
        const row = document.createElement('tr');
        row.id = `row-${displayId}`;
        row.onclick = () => { map.setView([p.lat, p.lon], 17); m.openPopup(); };
        row.innerHTML = `<td>${displayId}</td><td><input type="text" oninput="state.points[${index}].att=this.value; saveState()" value="${p.att}"></td><td style="font-weight:bold">${p.kmTot.toFixed(3)}</td><td>${p.kmParz.toFixed(3)}</td><td style="color:var(--warn)">${p.avg}</td><td>${p.time}</td><td><input type="text" oninput="state.points[${index}].preRil=this.value; saveState()" value="${p.preRil}"></td><td><input type="text" oninput="state.points[${index}].note=this.value; saveState()" value="${p.note}"></td><td onclick="event.stopPropagation(); deletePoint(${index})">üóë</td>`;
        tb.appendChild(row);
    });
}

function deletePoint(index) { if(confirm("Eliminare?")) { state.points.splice(index,1); refreshTableUI(); saveState(); } }

function takePhoto() { if (state.lastFix) document.getElementById("cameraInput").click(); }
document.getElementById("cameraInput").onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        const photo = { lat:state.lastFix.lat, lon:state.lastFix.lon, dataUrl:reader.result };
        state.photos.push(photo);
        L.marker([photo.lat, photo.lon], {icon: photoIcon}).addTo(map);
        saveState(); toast("Foto OK");
    };
    reader.readAsDataURL(file);
};

function exportCSV() {
    let csv = "ID;ATT;KM_TOT;KM_PARZ;MEDIA;ORA;PRERIL;NOTE;ALT;LAT_DEC;LON_DEC;LAT_DDM;LON_DDM\n";
    state.points.slice().reverse().forEach((p, i) => {
        // Formato: N45 12.345
        csv += `${i+1};${p.att};${p.kmTot.toFixed(3).replace('.',',')};${p.kmParz.toFixed(3).replace('.',',')};${p.avg};${p.time};${p.preRil};${p.note};${p.alt};${p.lat.toFixed(6).replace('.',',')};${p.lon.toFixed(6).replace('.',',')};${formatDDM(p.lat,true)};${formatDDM(p.lon,false)}\n`;
    });
    // Aggiungo il BOM per Excel (evita i caratteri strani tipo √Ç¬∞)
    const blob = new Blob(["\uFEFF", csv], {type:"text/csv;charset=utf-8"});
    download(blob, state.sessionName + ".csv");
}

async function exportZIP() {
    const zip = new JSZip();
    let kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>${state.sessionName}</name>`;
    kml += `<Style id="trackStyle"><LineStyle><color>ccdbd44d</color><width>5</width></LineStyle></Style>`;
    kml += `<Style id="pntIcon"><IconStyle><Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon></IconStyle></Style>`;
    kml += `<Style id="camIcon"><IconStyle><Icon><href>http://maps.google.com/mapfiles/kml/shapes/camera.png</href></Icon></IconStyle></Style>`;
    kml += `<Folder><name>TRACCE</name>`;
    state.trackSegments.forEach((seg, i) => {
        if(seg.length > 1) {
            let coords = seg.map(p => `${p.lon},${p.lat},${p.alt||0}`).join(" ");
            kml += `<Placemark><name>T${i+1}</name><styleUrl>#trackStyle</styleUrl><LineString><coordinates>${coords}</coordinates></LineString></Placemark>`;
        }
    });
    kml += `</Folder><Folder><name>PUNTI</name>`;
    state.points.slice().reverse().forEach((p, i) => { kml += `<Placemark><name>${i+1}</name><styleUrl>#pntIcon</styleUrl><Point><coordinates>${p.lon},${p.lat},${p.alt}</coordinates></Point></Placemark>`; });
    kml += `</Folder><Folder><name>FOTO</name>`;
    state.photos.forEach((ph, i) => {
        const name = `foto_${i+1}.jpg`;
        zip.file("files/"+name, ph.dataUrl.split(',')[1], {base64:true});
        kml += `<Placemark><name>F${i+1}</name><styleUrl>#camIcon</styleUrl><description><![CDATA[<img src="files/${name}" width="400"/>]]></description><Point><coordinates>${ph.lon},${ph.lat},0</coordinates></Point></Placemark>`;
    });
    kml += `</Folder></Document></kml>`;
    zip.file(state.sessionName + ".kml", kml);
    const content = await zip.generateAsync({type:"blob"});
    download(content, state.sessionName + ".zip");
}

function exportGPX() {
    let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" xmlns="http://www.topografix.com/GPX/1/1">`;
    state.points.slice().reverse().forEach((p, i) => { gpx += `<wpt lat="${p.lat}" lon="${p.lon}"><ele>${p.alt}</ele><name>${i+1}</name></wpt>`; });
    gpx += `</gpx>`;
    download(new Blob([gpx], {type:"application/gpx+xml"}), state.sessionName + ".gpx");
}
function download(blob, name) { const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = name; a.click(); }

function openKmModal() {
    const val = state.odoTotKm.toFixed(3).padStart(7, '0');
    document.getElementById("fullKmInput").value = state.odoTotKm.toFixed(3);
    renderDigitSelectors(val);
    document.getElementById("kmModal").style.display = 'flex';
}
function renderDigitSelectors(val) {
    const container = document.getElementById("digitSelectors");
    container.innerHTML = ''; let digitIdx = 0;
    [...val].forEach((char) => {
        if(char === '.') container.insertAdjacentHTML('beforeend', '<div class="digit-val">.</div>');
        else {
            const i = digitIdx;
            container.insertAdjacentHTML('beforeend', `<div class="digit-col"><button class="step-btn" onclick="stepDigit(${i}, 1)">+</button><div class="digit-val" id="digit-${i}">${char}</div><button class="step-btn" onclick="stepDigit(${i}, -1)">-</button></div>`);
            digitIdx++;
        }
    });
}
function stepDigit(idx, delta) {
    const el = document.getElementById(`digit-${idx}`);
    el.innerText = (parseInt(el.innerText) + delta + 10) % 10;
    syncInputFromDigits();
}
function syncInputFromDigits() {
    let s = ""; let digitIdx = 0;
    const currentVal = parseFloat(document.getElementById("fullKmInput").value || 0).toFixed(3).padStart(7, '0');
    [...currentVal].forEach(char => {
        if(char === '.') s += '.'; else { s += document.getElementById(`digit-${digitIdx}`).innerText; digitIdx++; }
    });
    document.getElementById("fullKmInput").value = parseFloat(s).toFixed(3);
}
function syncDigitsFromInput() {
    const val = parseFloat(document.getElementById("fullKmInput").value || 0).toFixed(3).padStart(7, '0');
    renderDigitSelectors(val);
}
function saveKmModal() {
    state.odoTotKm = parseFloat(document.getElementById("fullKmInput").value);
    updateUI(); saveState(); closeKmModal();
}
function closeKmModal() { document.getElementById("kmModal").style.display = 'none'; }

function toggleRec() {
    state.recording = !state.recording;
    document.getElementById("recBtn").textContent = state.recording ? "REC" : "PAUSA";
    document.getElementById("recBtn").className = state.recording ? "rec" : "pause";
    if (state.recording) {
        state.trackSegments.push([]);
        runtime.currentPolyline = L.polyline([], {color: "#4dd4ac", weight:4, opacity: 0.8}).addTo(map);
        runtime.trackLines.push(runtime.currentPolyline);
    }
    saveState();
}
function toast(m) { let t = document.getElementById("toast"); t.textContent = m; t.classList.add("show"); setTimeout(() => t.classList.remove("show"), 2000); }
function recenter() { if(state.lastFix) map.setView([state.lastFix.lat, state.lastFix.lon], 16); }
</script>
</body>
</html>
